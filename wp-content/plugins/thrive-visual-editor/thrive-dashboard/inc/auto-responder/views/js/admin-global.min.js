/*! Thrive Dashboard - 2016-07-11
* http://www.thrivethemes.com/
* Copyright (c) 2016 Thrive Themes */
var TVE_Dash=TVE_Dash||{};TVE_Dash.API=TVE_Dash.API||{},TVE_Dash.API.models=TVE_Dash.API.models||{},TVE_Dash.API.collections=TVE_Dash.API.collections||{},TVE_Dash.API.views=TVE_Dash.API.views||{},function(a){"use strict";_.templateSettings={evaluate:/<#([\s\S]+?)#>/g,interpolate:/<#=([\s\S]+?)#>/g,escape:/<#-([\s\S]+?)#>/g},Backbone.emulateHTTP=!0;var b=Backbone.Router.extend({routes:{"done/:api":"done","failed/:api":"failed","edit/:api":"edit"},done:function(a){TVE_Dash.API.ConnectedAPIs.findWhere({key:a}).set("state","done")},failed:function(a){TVE_Dash.API.ToBeConnected.set({key:a,state:"error",response:{message:tve_dash_api_error.message,success:!1}})},edit:function(a){TVE_Dash.API.ConnectedAPIs.findWhere({key:a}).set("state","edit")}});TVE_Dash.API.models.Connection=Backbone.Model.extend({defaults:{state:""}}),TVE_Dash.API.models.ToBeConnected=Backbone.Model.extend({defaults:{state:"new"}}),TVE_Dash.API.models.APIType=Backbone.Model.extend({}),TVE_Dash.API.collections.APITypes=Backbone.Collection.extend({model:TVE_Dash.API.models.APIType}),TVE_Dash.API.collections.Connections=Backbone.Collection.extend({model:TVE_Dash.API.models.Connection,getAPIs:function(a){a!==!0&&(a=!1);var a=this.filter(function(b){return b.get("connected")===a});return new TVE_Dash.API.collections.Connections(a)},getByType:function(a){if(void 0===a)return this;var b=this.filter(function(b){return b.get("type")===a});return new TVE_Dash.API.collections.Connections(b)}}),TVE_Dash.API.views.Connection=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"change:state",_.bind(this.renderState,this))},render:function(){return this.renderState(),this},renderState:function(){var a,b,c;return a=this.model.get("state").length?this.model.get("state")[0].toUpperCase()+this.model.get("state").slice(1):"connected",b=TVE_Dash.API.views["Connection"+a]?new TVE_Dash.API.views["Connection"+a]({model:this.model,collection:this.collection}):new TVE_Dash.API.views.ConnectionConnected({model:this.model,collection:this.collection}),"Edit"===a&&(c=!0),b.render(c),this.$el.replaceWith(b.$el),this.setElement(b.$el),window.rebindWistiaFancyBoxes&&window.rebindWistiaFancyBoxes(),this.$el.find("select").select2(),this}}),TVE_Dash.API.views.ConnectionConnected=Backbone.View.extend({className:"tvd-col tvd-s6 tvd-ms6 tvd-m4 tvd-l3",events:{"click .tvd-api-edit":function(){this.collection.each(_.bind(function(a){a.set("state","connected")},this)),this.model.set("state","edit")},"click .tvd-api-test":function(){this.model.set("state","test")},"click .tvd-api-delete":function(){this.model.set("state","delete")}},render:function(){return TVE_Dash.API.ToBeConnected.set("state","new"),this.$el.html(TVE_Dash.tpl("tvd-api-connected",{item:this.model})),this}}),TVE_Dash.API.views.ConnectionTest=Backbone.View.extend({className:"tvd-col tvd-s6 tvd-ms6 tvd-m4 tvd-l3",events:{"click .tvd-close-card":function(){this.model.set("state","connected")},"click .tvd-close-anywhere":function(){this.model.set("state","connected")}},render:function(){return this.$el.html(TVE_Dash.tpl("tvd-api-connection-hover",{text:TVE_Dash_Const.translations.Testing,color:"",icon:"tvd-no-icon"})),TVE_Dash.cardLoader(this.$el.find(".tvd-card")),this.test(),this},test:function(){var b=this,c=a.ajax({type:"post",url:ajaxurl,dataType:"json",data:{api:this.model.get("key"),action:TVE_Dash_Const.actions.api_handle_save,test:!0}});c.fail(function(){b.model.set("title","Connection Error"),b.model.set("state","connected")}),c.done(function(a){var c={};a.success?(c.text=TVE_Dash_Const.translations.ConnectionWorks,c.color="tvd-green tvd-close-anywhere",c.icon="tvd-icon-check",b.$el.html(TVE_Dash.tpl("tvd-api-connection-hover",c))):(b.model.set("response",a),b.model.set("state","error"))})}}),TVE_Dash.API.views.ConnectionError=Backbone.View.extend({className:"tvd-col tvd-s6 tvd-ms6 tvd-m4 tvd-l3",events:{"click .tvd-api-edit":function(){this.model.set("state","edit")},"click .tvd-close-card":function(){this.model.set("state","connected")}},render:function(){return this.$el.html(TVE_Dash.tpl("tvd-api-connection-error",{item:this.model})),this}}),TVE_Dash.API.views.ConnectionDelete=Backbone.View.extend({className:"tvd-col tvd-s6 tvd-ms6 tvd-m4 tvd-l3",events:{"click .tvd-api-delete-yes":"yes","click .tvd-api-delete-no":function(){this.model.set("state","connected")}},render:function(){return this.$el.html(TVE_Dash.tpl("tvd-api-confirm-delete",{item:this.model})),this},yes:function(){var b=this,c=a.ajax({type:"post",url:ajaxurl,data:{api:this.model.get("key"),action:TVE_Dash_Const.actions.api_handle_save,disconnect:!0},dataType:"json"});this.$el.find(".tvd-card").replaceWith(TVE_Dash.tpl("tvd-api-connection-hover",{text:TVE_Dash_Const.translations.Deleting,color:"tvd-red",icon:"tvd-icon-spinner mdi-pulse"})),c.fail(function(a){b.model.set("state","connected")}),c.done(function(a){if(a.success){var c=new TVE_Dash.API.models.Connection({connected:!1,key:b.model.get("key"),credentials:b.model.get("credentials"),title:b.model.get("title"),type:b.model.get("type"),logoUrl:b.model.get("logoUrl")});b.collection.remove(b.model),b.remove(),TVE_Dash.API.AvailableAPIs.push(c)}else b.model.set("state","connected")})}}),TVE_Dash.API.views.ConnectionDone=Backbone.View.extend({className:"tvd-col tvd-s6 tvd-ms6 tvd-m4 tvd-l3",events:{"click .tvd-api-done":function(){this.model.set("state","connected"),TVE_Dash.API.router.navigate("",{trigger:!0})}},render:function(){return this.$el.html(TVE_Dash.tpl("tvd-api-state-success",{item:this.model})),this}}),TVE_Dash.API.views.ConnectionSuccess=TVE_Dash.API.views.ConnectionDone.extend({}),TVE_Dash.API.views.NewState=Backbone.View.extend({className:"tvd-col tvd-s12 tvd-m4 tvd-l3",events:{"click .tvd-card-content":function(){this.model.set("state","select")}},render:function(){return this.$el.html(TVE_Dash.tpl("tvd-api-state-new",{item:this.model})),this}}),TVE_Dash.API.views.HiddenState=Backbone.View.extend({render:function(){return this}}),TVE_Dash.API.views.SelectState=Backbone.View.extend({className:"tvd-col tvd-s12 tvd-m4 tvd-l3",events:{"change #selected-api":"onAPISelect"},render:function(){return this.$el.html(TVE_Dash.tpl("tvd-api-state-select",{item:this.model})),this.renderAPIsList(),this},onAPISelect:function(b){var c=a(b.target);"none"!==c.val()&&(this.model.set("key",c.val()),this.model.set("state","form"))},renderAPIsList:function(){var b=this.$el.find("#selected-api");TVE_Dash.API.APITypes.each(function(c){var d=a("<optgroup/>").attr("label",c.get("label")),e=this.collection.getAPIs(!1).getByType(c.get("type"));e.each(function(b){var c=a("<option/>").html(b.get("title")).attr("value",b.get("key"));d.append(c)},this),e.length&&b.append(d)},this)}}),TVE_Dash.API.views.FormState=Backbone.View.extend({className:"tvd-col tvd-s6 tvd-ms6 tvd-m4 tvd-l3",input_selector:"input[type=text], input[type=password], input[type=email], input[type=url], input[type=tel], input[type=number], input[type=search], textarea",events:{"click .tvd-api-cancel":function(){this.model.set("state","new")},"click .tvd-api-connect":"connect","click .tvd-api-redirect":"redirect","keypress .tvd-api-add-chip":"addChip","click .tvd-icon-close2":"deleteChip"},render:function(b){if(TVE_Dash.API.ToBeConnected.set("state","hidden"),this.$el.html(TVE_Dash.tpl("tvd-api-state-form",{item:this.model})),this.$el.find(".tvd-card-content").prepend(TVE_Dash.tpl("tvd-api-form-"+this.model.get("key"),{item:this.model})),b!==!0&&"awsses"!==this.model.get("key")&&this.$el.find('input[type="text"]').val(""),this.$el.find(this.input_selector).each(function(b,c){a(c).val().length>0||void 0!==a(this).attr("placeholder")||a(c)[0].validity.badInput===!0?a(this).siblings("label").addClass("tvd-active"):a(this).siblings("label, i").removeClass("tvd-active")}),1===this.model.get("new_credentials")){var c=this;a.each(this.model.get("credentials"),function(a,b){c.$el.find('input[name="connection['+a+']"]').val(b)}),this.model.unset("new_credentials")}return this},addChip:function(b){if(13===b.keyCode){var c=a(b.target);if(c.val().length){var d=a("<input/>").attr("type","hidden").attr("name",c.data("name")).val(c.val()),e=a('<div class="tvd-chip">'+c.val()+'<i class="tvd-icon-close2"></i></div>');e.on("click",".tvd-icon-close2",_.bind(this.deleteChip,this)),this.$el.find("form").prepend(d),this.$el.find(".tvd-api-chip-wrapper").append(e),c.val("")}}},deleteChip:function(b){var c=a(b.target).parent(),d=c.contents().filter(function(){return 3===this.nodeType}).text();this.$el.find('input[value="'+d+'"]').remove(),c.remove()},connect:function(){var b=this.$el.find("form").serialize(),c={};a.each(this.$el.find("form").serializeArray(),function(a,b){c[b.name]=b.value}),b+="&action="+TVE_Dash_Const.actions.api_handle_save;var d={};for(var e in this.model.get("credentials"))d[e]=c["connection["+e+"]"];var f=this,g=a.ajax({url:ajaxurl,type:"post",dataType:"json",data:b});TVE_Dash.cardLoader(this.$el),g.fail(function(a){TVE_Dash.hideCardLoader(f.$el),f.model.set("response",{success:!1,message:TVE_Dash_Const.translations.UnknownError}),f.model.set("state","error")}),g.done(function(a){TVE_Dash.hideCardLoader(f.$el),a.success?"0"===a?(f.model.set("response",{success:!1,message:TVE_Dash_Const.translations.UnknownError}),f.model.set("state","error")):(f.model.set("credentials",d),f.model.set("new_credentials",1),f.model.set("response",a),f.model.set("state","success")):(f.model.set("response",a),f.model.set("state","error"))})},redirect:function(){var b=this.$el.find("form").serialize(),c={};a.each(this.$el.find("form").serializeArray(),function(a,b){c[b.name]=b.value}),b+="&action="+TVE_Dash_Const.actions.api_handle_redirect;var d={};for(var e in this.model.get("credentials"))d[e]=c["connection["+e+"]"];var f=this,g=a.ajax({url:ajaxurl,type:"post",dataType:"json",data:b});TVE_Dash.cardLoader(this.$el),g.fail(function(a){TVE_Dash.hideCardLoader(f.$el),f.model.set("response",{success:!1,message:TVE_Dash_Const.translations.UnknownError}),f.model.set("state","error")}),g.done(function(a){a.success?"0"===a?(f.model.set("response",{success:!1,message:TVE_Dash_Const.translations.UnknownError}),f.model.set("state","error")):window.location.href=a.message:(f.model.set("response",a),f.model.set("state","error")),TVE_Dash.hideCardLoader(f.$el)})}}),TVE_Dash.API.views.ErrorState=Backbone.View.extend({className:"tvd-col tvd-s6 tvd-ms6 tvd-m4 tvd-l3",events:{"click .tvd-api-cancel":function(){this.model.set("state","new")},"click .tvd-api-retry":function(){this.model.set("state","form")}},render:function(){return this.$el.html(TVE_Dash.tpl("tvd-api-state-error",{item:this.model})),this}}),TVE_Dash.API.views.SuccessState=Backbone.View.extend({className:"tvd-col tvd-s6 tvd-ms6 tvd-m4 tvd-l3",events:{"click .tvd-api-done":function(){var a=TVE_Dash.API.AvailableAPIs.findWhere({key:this.model.get("key")});a.set("connected",!0),a.set("state","connected"),this.model.clear({silent:!0}),this.model.set("state","new"),TVE_Dash.API.ConnectedAPIs.push(a),TVE_Dash.API.AvailableAPIs.remove(a)}},render:function(){return this.$el.html(TVE_Dash.tpl("tvd-api-state-success",{item:this.model})),this}}),TVE_Dash.API.views.ToBeConnected=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"change:state",_.bind(this.renderState,this))},render:function(){return this.collection.getAPIs(!1).length<=0?(this.$el.html(""),this):(this.renderState(),this)},renderState:function(){var a=this.model.get("state")[0].toUpperCase()+this.model.get("state").slice(1);if(TVE_Dash.API.views[a+"State"])var b=new TVE_Dash.API.views[a+"State"]({model:this.model,collection:this.collection});else var b=new TVE_Dash.API.views.NewState({model:this.model});b.render(),this.$el.replaceWith(b.$el),this.setElement(b.$el),this.$el.find("select").select2(),window.rebindWistiaFancyBoxes&&window.rebindWistiaFancyBoxes()}}),TVE_Dash.API.views.ConnectionEdit=TVE_Dash.API.views.FormState.extend({}),TVE_Dash.API.views.App=Backbone.View.extend({el:".tvd-api-list",initialize:function(){this.listenTo(this.collection,"add",_.bind(this.renderConnection,this))},render:function(){this.$el.html(""),this.renderAddNewConnection(TVE_Dash.API.ToBeConnected),this.collection.each(this.renderConnection,this)},renderConnection:function(a){var b=new TVE_Dash.API.views.Connection({model:a,collection:this.collection});this.$el.find("> .tvd-col").last().before(b.render().$el)},renderAddNewConnection:function(a){var b=new TVE_Dash.API.views.ToBeConnected({model:a,collection:TVE_Dash.API.AvailableAPIs});this.$el.append(b.render().$el)}}),a(function(){window.app=new TVE_Dash.API.views.App({collection:TVE_Dash.API.ConnectedAPIs}),window.app.render(),TVE_Dash.API.router=new b,Backbone.history.start(),TVE_Dash.showLoader(),setTimeout(function(){a(".tvd-show-onload").removeClass("tvd-hide"),TVE_Dash.hideLoader()},200)})}(jQuery);